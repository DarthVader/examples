-- select top 100 * from history
-- truncate table history_test
-- select * from [dbo].[history_test]

declare @json as varchar(max)

set @json = '{"exchange": "exmo", "pair": "ETH/USDT", "histories": [{"trade_id": 66387661, "type": "buy", "quantity": "0.14493", "price": "358.67", "amount": "51.9820431", "date": 1533892691}, {"trade_id": 66388103, "type": "sell", "quantity": "0.0196026", "price": "356.37771426", "amount": "6.98592978", "date": 1533893109}, {"trade_id": 66388506, "type": "sell", "quantity": "0.011", "price": "356.37771426", "amount": "3.92015485", "date": 1533893248}, {"trade_id": 66388592, "type": "sell", "quantity": "0.12779", "price": "357.95", "amount": "45.7424305", "date": 1533893273}, {"trade_id": 66388913, "type": "sell", "quantity": "0.01959627", "price": "356.37771426", "amount": "6.98367391", "date": 1533893442}, {"trade_id": 66388928, "type": "sell", "quantity": "0.01959626", "price": "356.37771426", "amount": "6.98367034", "date": 1533893445}, {"trade_id": 66388958, "type": "sell", "quantity": "0.01959572", "price": "356.37771426", "amount": "6.9834779", "date": 1533893456}, {"trade_id": 66389042, "type": "sell", "quantity": "0.13", "price": "357.8", "amount": "46.514", "date": 1533893545}, {"trade_id": 66389287, "type": "sell", "quantity": "0.1378", "price": "357.2", "amount": "49.22216", "date": 1533893814}, {"trade_id": 66389555, "type": "buy", "quantity": "0.152", "price": "358.3", "amount": "54.4616", "date": 1533894228}, {"trade_id": 66390061, "type": "sell", "quantity": "0.147", "price": "357", "amount": "52.479", "date": 1533894624}, {"trade_id": 66390693, "type": "buy", "quantity": "0.1312", "price": "358.72", "amount": "47.064064", "date": 1533894983}, {"trade_id": 66390900, "type": "sell", "quantity": "0.13937", "price": "357.95", "amount": "49.8874915", "date": 1533895221}, {"trade_id": 66391407, "type": "buy", "quantity": "0.165", "price": "358.9", "amount": "59.2185", "date": 1533895762}, {"trade_id": 66392141, "type": "sell", "quantity": "0.13", "price": "356.946", "amount": "46.40298", "date": 1533896235}, {"trade_id": 66392375, "type": "sell", "quantity": "0.1611", "price": "357.988", "amount": "57.6718668", "date": 1533896446}, {"trade_id": 66392648, "type": "buy", "quantity": "0.16",
"price": "359.12", "amount": "57.4592", "date": 1533896767}, {"trade_id": 66392943, "type": "sell", "quantity": "0.16", "price": "358", "amount": "57.28", "date": 1533897237}, {"trade_id": 66393336, "type": "sell", "quantity": "0.1442", "price": "358.462", "amount": "51.6902204", "date": 1533897878}, {"trade_id": 66393506, "type": "buy", "quantity": "0.13", "price": "358.948", "amount": "46.66324", "date": 1533898145}, {"trade_id": 66393569, "type": "sell", "quantity": "0.15", "price": "358.43", "amount": "53.7645", "date": 1533898200}, {"trade_id": 66393858, "type": "buy", "quantity": "0.1582", "price": "358.25", "amount": "56.67515", "date": 1533898663}, {"trade_id": 66394020, "type": "buy", "quantity": "0.1391", "price": "358.34", "amount": "49.845094", "date": 1533898864}, {"trade_id": 66394516, "type": "buy", "quantity": "0.14567", "price": "358.439", "amount": "52.21380913", "date": 1533899278}, {"trade_id": 66394617, "type": "sell", "quantity": "0.57485742", "price": "357.09100482", "amount": "205.27641373", "date": 1533899371}, {"trade_id": 66394691, "type": "buy", "quantity": "0.1476", "price": "358.853", "amount": "52.9667028", "date": 1533899490}, {"trade_id": 66395433, "type": "sell", "quantity": "0.14265", "price": "357.029", "amount": "50.93018685", "date": 1533900107}, {"trade_id": 66395584, "type": "sell", "quantity": "0.14203", "price": "357.829", "amount": "50.82245287", "date": 1533900204}, {"trade_id": 66396046, "type": "sell", "quantity": "0.17", "price": "357.47", "amount": "60.7699", "date": 1533900626}, {"trade_id": 66396270, "type": "sell", "quantity": "0.1532", "price": "357.78", "amount": "54.811896", "date": 1533900859}, {"trade_id": 66396498, "type": "buy", "quantity": "0.1601", "price": "358.32", "amount": "57.367032", "date": 1533901151}, {"trade_id": 66396916, "type": "sell", "quantity": "0.1443", "price": "357.494", "amount": "51.5863842", "date": 1533901496}, {"trade_id": 66397275, "type": "sell", "quantity": "0.12", "price": "357.39", "amount": "42.8868", "date": 1533901909}, {"trade_id": 66397619, "type": "buy", "quantity": "0.1409", "price": "357.39", "amount": "50.356251", "date": 1533902149}, {"trade_id": 66397950, "type": "sell", "quantity": "0.13798", "price": "357.238", "amount": "49.29169924", "date": 1533902322}, {"trade_id": 66398649, "type": "buy", "quantity": "0.01032164", "price": "358.69424585", "amount": "3.70231287", "date": 1533902755}, {"trade_id": 66398652, "type": "buy", "quantity": "0.00000877", "price": "359.59232933", "amount": "0.00315362", "date": 1533902756}, {"trade_id": 66398651, "type":
"buy", "quantity": "0.01074975", "price": "358.69424585", "amount": "3.85587346", "date": 1533902756}, {"trade_id": 66398726, "type": "buy", "quantity": "0.01695352", "price": "359.59233033", "amount": "6.09635576", "date": 1533902774}, {"trade_id": 66398725, "type": "buy", "quantity": "0.01021443", "price": "359.59232933", "amount": "3.67303067", "date": 1533902774}, {"trade_id": 66398741, "type": "buy", "quantity": "0.01573087", "price": "359.59233033", "amount": "5.6567002", "date": 1533902777}, {"trade_id": 66398783, "type": "buy", "quantity": "0.06921614", "price": "359.59233033", "amount": "24.88959307", "date": 1533902789}, {"trade_id": 66398848, "type": "buy", "quantity": "0.1267", "price":
"359.35", "amount": "45.529645", "date": 1533902816}, {"trade_id": 66399296, "type": "buy", "quantity": "0.01377796", "price": "360.85090281", "amount": "4.9717893", "date": 1533902850}, {"trade_id": 66399379, "type": "buy", "quantity": "0.10178671", "price": "360.85090349", "amount": "36.72982626", "date": 1533902857}, {"trade_id": 66399880, "type": "sell", "quantity": "0.11781", "price": "359.61", "amount": "42.3656541", "date": 1533902999}, {"trade_id": 66400171, "type": "buy", "quantity": "0.01975784", "price": "361.20950164", "amount": "7.13671953", "date": 1533903111}, {"trade_id": 66400576, "type": "buy", "quantity": "0.1319", "price": "361.26", "amount": "47.650194", "date": 1533903366}, {"trade_id": 66400865, "type": "buy", "quantity": "0.1637", "price": "361.5", "amount": "59.17755", "date": 1533903751}, {"trade_id": 66400925, "type": "buy", "quantity": "0.01", "price": "362.11388165", "amount": "3.62113881", "date": 1533903803}, {"trade_id": 66400924, "type": "buy", "quantity": "0.10181854", "price": "362.11388165", "amount": "36.86990674", "date": 1533903803}, {"trade_id": 66401060, "type": "sell", "quantity": "0.1604", "price": "361.68", "amount": "58.013472", "date": 1533904081}, {"trade_id": 66401498, "type": "sell", "quantity": "0.11543", "price": "360.78", "amount": "41.6448354", "date": 1533904472}, {"trade_id": 66401863, "type": "buy", "quantity": "0.14", "price": "362.25",
"amount": "50.715", "date": 1533904835}, {"trade_id": 66402092, "type": "buy", "quantity": "0.04362038", "price": "362.65506155", "amount": "15.81915159", "date": 1533905176}, {"trade_id": 66402357, "type": "buy", "quantity": "0.153", "price": "362.182", "amount": "55.413846", "date": 1533905379}, {"trade_id": 66402909, "type": "buy", "quantity": "0.12814", "price": "363.02", "amount": "46.5173828", "date": 1533905811}, {"trade_id": 66403149, "type": "buy", "quantity": "0.16582", "price": "362.93", "amount": "60.1810526", "date": 1533905929}, {"trade_id": 66403460, "type": "buy", "quantity": "0.011", "price": "362.2924971", "amount": "3.98521746", "date": 1533906296}, {"trade_id": 66403566, "type":
"buy", "quantity": "0.14727", "price": "361.25", "amount": "53.2012875", "date": 1533906454}, {"trade_id": 66403697, "type": "buy", "quantity": "0.144", "price": "361.43", "amount": "52.04592", "date": 1533906637}, {"trade_id": 66403897, "type": "buy", "quantity": "0.47149377", "price": "362.2924971", "amount": "170.8186553", "date": 1533906886}, {"trade_id": 66404008, "type": "buy", "quantity": "0.15", "price": "361.6", "amount": "54.24", "date": 1533907026}, {"trade_id": 66404113, "type": "sell", "quantity": "0.143", "price": "360.68", "amount": "51.57724", "date": 1533907197}, {"trade_id": 66404409, "type": "buy", "quantity": "0.12", "price": "362.777", "amount": "43.53324", "date": 1533907584},
{"trade_id": 66404687, "type": "sell", "quantity": "0.10183912", "price": "360.13279242", "amount": "36.67560666", "date": 1533908181}, {"trade_id": 66404699, "type": "sell", "quantity": "0.15", "price": "358.87672562", "amount": "53.83150884", "date": 1533908221}, {"trade_id": 66404734, "type": "buy", "quantity": "0.14", "price": "361.46", "amount": "50.6044", "date": 1533908293}, {"trade_id": 66405059, "type": "buy", "quantity": "0.126", "price": "361.607", "amount": "45.562482", "date": 1533908628}, {"trade_id": 66405072, "type": "buy", "quantity": "0.10126364", "price": "362.11388165", "amount": "36.66896975", "date": 1533908642}, {"trade_id": 66405141, "type": "sell", "quantity": "0.02499641",
"price": "361.21643857", "amount": "9.02911419", "date": 1533908746}, {"trade_id": 66405780, "type": "sell", "quantity": "0.1178", "price": "361.132", "amount": "42.5413496", "date": 1533909272}, {"trade_id": 66406050, "type": "sell", "quantity": "0.14027", "price": "361.3", "amount": "50.679551", "date": 1533909589}, {"trade_id": 66406442, "type": "buy", "quantity": "0.15169", "price": "361.72", "amount": "54.8693068", "date": 1533909976}, {"trade_id": 66406791, "type": "sell", "quantity": "0.00006352", "price": "358.87672388", "amount": "0.02279584", "date": 1533910122}, {"trade_id": 66406790, "type": "sell", "quantity": "0.10165848", "price": "360.13279242", "amount": "36.61055227", "date": 1533910122}, {"trade_id": 66407106, "type": "buy", "quantity": "0.114", "price": "360.318", "amount": "41.076252", "date": 1533910326}, {"trade_id": 66407143, "type": "buy", "quantity": "0.1337", "price": "360.778", "amount": "48.2360186", "date": 1533910391}, {"trade_id": 66407159, "type": "buy", "quantity": "0.70689885", "price": "361.5684546", "amount": "255.59232475", "date": 1533910413}, {"trade_id": 66407158, "type": "buy", "quantity": "0.07070115", "price": "361.38767037", "amount": "25.55052389", "date": 1533910413}, {"trade_id": 66407168, "type": "buy", "quantity": "0.03", "price": "361.56845462", "amount": "10.84705363", "date": 1533910428}, {"trade_id": 66407489, "type": "buy", "quantity": "0.167", "price": "360.77", "amount": "60.24859", "date": 1533910768}, {"trade_id": 66407669, "type": "sell", "quantity": "0.16", "price": "359.874", "amount": "57.57984", "date": 1533911056}, {"trade_id": 66407922, "type": "sell", "quantity": "0.146", "price": "359.85", "amount": "52.5381", "date": 1533911549}, {"trade_id": 66408180, "type": "sell", "quantity": "0.13258", "price": "359.73", "amount": "47.6930034", "date": 1533911678}, {"trade_id": 66408303, "type": "sell", "quantity": "0.0149256", "price": "358.87672388", "amount": "5.35645042", "date": 1533911730}, {"trade_id": 66408302, "type": "sell", "quantity": "0.01", "price": "358.87672389", "amount": "3.58876723", "date": 1533911730}, {"trade_id": 66408323, "type": "sell", "quantity": "0.01793846", "price": "358.87672388", "amount": "6.43769575", "date": 1533911738}, {"trade_id": 66408348, "type": "sell", "quantity": "0.01793843", "price": "358.87672388", "amount": "6.43768498", "date": 1533911747}, {"trade_id": 66408396, "type": "sell", "quantity": "0.01793788", "price": "358.87672388", "amount": "6.4374876", "date": 1533911760}, {"trade_id": 66408640, "type": "sell", "quantity": "0.12", "price": "360.19", "amount": "43.2228", "date": 1533912082}, {"trade_id": 66408783, "type": "sell", "quantity": "0.011", "price": "358.87672388", "amount": "3.94764396", "date": 1533912245}, {"trade_id": 66408786, "type": "sell", "quantity": "0.011", "price": "358.87672388", "amount": "3.94764396", "date": 1533912246}, {"trade_id": 66409041, "type": "sell", "quantity": "0.145", "price": "359.529", "amount": "52.131705", "date": 1533912599}, {"trade_id": 66409232, "type": "sell", "quantity": "0.1656", "price": "359.41", "amount": "59.518296", "date": 1533912822}, {"trade_id": 66409494, "type": "buy", "quantity": "0.124", "price": "360.51", "amount": "44.70324", "date": 1533913111}, {"trade_id": 66409642, "type": "sell", "quantity": "0.16", "price": "359.595", "amount": "57.5352", "date": 1533913387}, {"trade_id": 66409751, "type": "sell", "quantity": "0.15872", "price": "359.804", "amount": "57.10809088", "date": 1533913561}, {"trade_id": 66409974, "type": "sell", "quantity": "0.11", "price": "359.198", "amount": "39.51178", "date": 1533913942}, {"trade_id": 66410028, "type": "sell", "quantity": "0.11", "price": "359.994", "amount": "39.59934", "date": 1533914081}]}'

--INSERT INTO [dbo].[history_test] ([insert_date],[timestamp],[ts],[exchange],[pair],[price],[amount],[type],[side],[id])
select 
	--, d.trade_date
	SYSDATETIME() insert_date, [timestamp], d.trade_date ts, exchange, pair, price, amount, [type], side, [id]
from  OPENJSON(@json) 
with (
	exchange varchar(50) '$.exchange',
	pair varchar(10) '$.pair'
) e
cross apply OPENJSON(@json,'$.histories')
with (
	[timestamp] bigint '$.date',
	[type] varchar(5) '$.type',
	--quantity float '$.quantity',
	price float '$.price',
	amount float '$.amount',
	side varchar(5) '$.side',
	[id] bigint	'$.trade_id'
) j
cross apply (SELECT DATEADD(second, [timestamp], CAST('1970-01-01 00:00:00' AS datetime)) trade_date) d

